<!doctype html>
<html lang="en">
  <%- include("./layout/server-var") %>

  <head>
    <%- include("./layout/header") %>
    <title>UNO Game</title>
  </head>

  <%- include("./layout/nav-bar") %>

  <body class="bg-gray-200 flex flex-col items-center justify-center h-screen">
    <div class="container mx-auto px-4">
      <div class="flex">
        <!-- UNO Game Interface -->
        <div class="w-full border border-red-500 p-4">
          <h2 class="text-lg font-bold mb-4 text-red-500">UNO GAME</h2>

          <div class="w-full border border-red-500">
            PLAYER 2 OR OTHERS CONTAINER
          </div>

          <div id="cardContainer" class="flex flex-wrap justify-center">
            <!-- Card images will be dynamically loaded here -->
          </div>

          <div class="flex justify-center mt-4">
            <button
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mr-2"
              id="startGameButton"
            >
              Start Game
            </button>

            <button
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mr-2 hidden"
              id="abandonButton"
            >
              Abandon
            </button>
            <button
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mr-2 hidden"
              id="drawButton"
            >
              Draw
            </button>
            <button
              class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded mr-2 hidden"
              id="sayUnoButton"
            >
              SAY UNO!
            </button>
          </div>

          <div class="w-full border border-red-500" id="player1Container">
            PLAYER 1 CONTAINER
          </div>
        </div>

        <%- include("./layout/chat-box") %>
      </div>
    </div>

    <script>
      // define variables to store game state
      let gameId = "<%= gameId %>";
      let userId = "<%= user.id %>";
      let userName = "<%= user.username %>";
      let playerDeck = []; // assuming playerDeck is an array containing the player's cards
      let playerDeck2 = []; // assuming playerDeck is an array containing the player's cards
      let drawCardPile = []; // assuming drawCardPile is an array containing the draw pile
      let playedCardsPile = []; // assuming playedCardsPile is an array containing the played cards
      let currentColor = ""; // current color of the game
      let currentNumber = ""; // current number of the game

      const cardImages = [
        "cards/Back.png",
        "cards/Blue_0.png",
        "cards/Blue_1.png",
        "cards/Blue_2.png",
        "cards/Blue_3.png",
        "cards/Blue_4.png",
        "cards/Blue_5.png",
        "cards/Blue_6.png",
        "cards/Blue_7.png",
        "cards/Blue_8.png",
        "cards/Blue_9.png",
        "cards/Blue_Draw.png",
        "cards/Blue_Reverse.png",
        "cards/Blue_Skip.png",
        "cards/Red_0.png",
        "cards/Red_1.png",
        "cards/Red_2.png",
        "cards/Red_3.png",
        "cards/Red_4.png",
        "cards/Red_5.png",
        "cards/Red_6.png",
        "cards/Red_7.png",
        "cards/Red_8.png",
        "cards/Red_9.png",
        "cards/Red_Draw.png",
        "cards/Red_Reverse.png",
        "cards/Red_Skip.png",
        "cards/Green_0.png",
        "cards/Green_1.png",
        "cards/Green_2.png",
        "cards/Green_3.png",
        "cards/Green_4.png",
        "cards/Green_5.png",
        "cards/Green_6.png",
        "cards/Green_7.png",
        "cards/Green_8.png",
        "cards/Green_9.png",
        "cards/Green_Draw.png",
        "cards/Green_Reverse.png",
        "cards/Green_Skip.png",
        "cards/Yellow_0.png",
        "cards/Yellow_1.png",
        "cards/Yellow_2.png",
        "cards/Yellow_3.png",
        "cards/Yellow_4.png",
        "cards/Yellow_5.png",
        "cards/Yellow_6.png",
        "cards/Yellow_7.png",
        "cards/Yellow_8.png",
        "cards/Yellow_9.png",
        "cards/Yellow_Draw.png",
        "cards/Yellow_Reverse.png",
        "cards/Yellow_Skip.png",
        "cards/Wild.png",
        "cards/Wild_Draw.png",
      ];

      // function to shuffle an array
      function shuffleArray(array) {
        console.log("[unogame.ejs] Shuffling the array...");
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // function to dynamically load card images onto the interface
      function loadCardImages() {
        const cardContainer = document.getElementById("cardContainer");
        cardImages.forEach((imageName, index) => {
          const cardImage = document.createElement("img");
          cardImage.src = imageName;
          cardImage.alt = "Card " + (index + 1);
          cardImage.classList.add("w-16", "h-24", "m-2");
          cardContainer.appendChild(cardImage);
        });
      }

      // function to initialize UNO game interface
      function initializeUNOGame() {
        // get references to HTML elements
        const unoGameInterface = document.getElementById("unoGameInterface");

        // load card images onto the interface
        // loadCardImages();

        // generate and add 7 random cards for PLAYER 1
        addRandomCardsToPlayer(player1Container, 7);

        // add event listener for the "Start Game" button
        const startGameButton = document.getElementById("startGameButton");
        startGameButton.addEventListener("click", startGame);

        // function to add random cards to a player's container
        function addRandomCardsToPlayer(container, count) {
          container.style.display = "flex"; // Set display to flex
          container.style.flexDirection = "row"; // Align cards horizontally

          for (let i = 0; i < count; i++) {
            const randomIndex = Math.floor(Math.random() * cardImages.length);
            const cardImage = cardImages[randomIndex];
            const cardElement = document.createElement("img");
            cardElement.src = cardImage;
            cardElement.alt = "Card " + (randomIndex + 1);
            cardElement.classList.add("w-16", "h-24", "m-2");
            container.appendChild(cardElement);
          }
        }
      }
      // function to start the game
      function startGame() {
        console.log("[unogame.ejs] Game started!");
        console.log("[unogame.ejs] Start Game button clicked!");

        // hide the "Start Game" button after being clicked
        const startGameButton = document.getElementById("startGameButton");
        startGameButton.style.display = "none";

        // draw 7 cards for the first player
        for (let i = 0; i < 7; i++) {
          const cardDrawn = drawCardFromPile(); // Draw a card from the draw pile
          playerDeck.push(cardDrawn); // Add the card to the player's deck
        }

        // draw 7 cards for the second player
        for (let i = 0; i < 7; i++) {
          const cardDrawn = drawCardFromPile(); // Draw a card from the draw pile
          playerDeck2.push(cardDrawn); // add the card to the second player's deck
        }

        // Abandon - Draw - Say UNO buttons
        showGameControls();

        // display the player's decks and the draw pile
        updateGameInterface();
      }

      // call initialize function when the page loads
      window.addEventListener("load", initializeUNOGame);

      // Function to draw a card from the draw pile
      function drawCardFromPile() {
        if (drawCardPile.length > 0) {
          console.log("[unogame.ejs] Drawing a card from the draw pile...");
          return drawCardPile.pop(); // remove and return the top card from the draw pile
        } else {
          console.log("[unogame.ejs] No cards left in the draw pile!");
          return null; // return null if there are no cards left in the draw pile
        }
      }

      // function to handle abandoning the game
      function abandonGame() {
        // prompt user for confirmation
        const confirmation = confirm(
          "Are you sure you want to abandon the game?"
        );

        // if user confirms, perform abandonment actions
        if (confirmation) {
          console.log(
            "[unogame.ejs] Abandon button clicked. Abandoning the game..."
          );
          // add abandonment logic here
        } else {
          console.log("[unogame.ejs] Abandonment canceled.");
        }
      }

      // function to handle saying UNO
      function sayUno() {
        // check if the player has only one card left
        if (playerDeck.length === 1) {
          console.log(
            "[unogame.ejs] SAY UNO! button clicked. Announcing UNO..."
          );
          // set a flag indicating that UNO has been said
          isUnoButtonPressed = true;
          // ? further logic here, such as informing the server
        } else {
          console.log(
            "[unogame.ejs] You can only say UNO when you have one card left in your deck."
          );
          // ? display a message to the user indicating they cannot say UNO yet
        }
      }

      // function to update game interface after drawing card
      function updateGameInterface() {
        // Display player's decks and the draw pile
        const unoGameInterface = document.getElementById("unoGameInterface");
        unoGameInterface.innerHTML = `
        <div>
          <p>Game Status: In Progress</p>
          <p>Current Color: ${currentColor}</p>
          <p>Current Number: ${currentNumber}</p>
          <div class="flex justify-between">
            <div>
              <p>Player Deck:</p>
              ${getPlayerDeckHTML(playerDeck)} <!-- Display player 1's deck -->
            </div>
            <div>
              <p>Draw Pile:</p>
              ${getDrawPileHTML()} <!-- Display the draw pile -->
            </div>
            <div>
              <p>Player 2 Deck:</p>
              ${getPlayerDeckHTML(playerDeck2)} <!-- Display player 2's deck -->
            </div>
          </div>
        </div>
       `;
      }

      // function to show game controls after starting the game
      function showGameControls() {
        // Show the game controls
        const abandonButton = document.getElementById("abandonButton");
        const drawButton = document.getElementById("drawButton");
        const sayUnoButton = document.getElementById("sayUnoButton");
        abandonButton.classList.remove("hidden");
        drawButton.classList.remove("hidden");
        sayUnoButton.classList.remove("hidden");
      }

      // console.log("[unogame.ejs] Page loaded. Initializing UNO game...");
    </script>
  </body>
</html>
